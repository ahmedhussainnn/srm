<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Result Management System</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .animated {
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .fadeIn {
            animation-name: fadeIn;
        }
        /* Add custom styles for login/signup if needed */
        #authForms {
            max-width: 500px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
         .dashboard-section {
            display: none; /* Hide sections initially */
         }
         .main-content {
            display: none; /* Hide main tabs initially */
         }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Student Result Management System</h1>

        <div id="authSection">
             <div class="row justify-content-center">
                <div class="col-md-6">
                    <div id="authForms">
                        <h3 class="text-center">Login / Sign Up</h3>
                        <ul class="nav nav-tabs nav-fill mb-3">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#loginTab">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#signupTab">Sign Up</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane container active" id="loginTab">
                                <form id="loginForm">
                                    <div class="form-group">
                                        <label for="loginEmail">Email address</label>
                                        <input type="email" class="form-control" id="loginEmail" placeholder="Enter email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="loginPassword">Password</label>
                                        <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                                    </div>
                                     <div class="alert alert-danger d-none" id="loginError"></div>
                                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                                </form>
                            </div>
                            <div class="tab-pane container fade" id="signupTab">
                                <form id="signupForm">
                                    <div class="form-group">
                                        <label for="signupEmail">Email address</label>
                                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signupPassword">Password</label>
                                        <input type="password" class="form-control" id="signupPassword" placeholder="Password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="signupConfirmPassword">Confirm Password</label>
                                        <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm Password" required>
                                    </div>
                                     <div class="alert alert-danger d-none" id="signupError"></div>
                                     <div class="alert alert-success d-none" id="signupSuccess"></div>
                                    <button type="submit" class="btn btn-success btn-block">Sign Up</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div id="mainContent" class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                 <span id="welcomeMessage">Welcome!</span>
                 <button id="logoutButton" class="btn btn-danger btn-sm">Logout</button>
            </div>

            <ul class="nav nav-tabs mb-3" id="mainTabs">
                </ul>

            <div class="tab-content" id="mainTabContent">
                <div class="tab-pane fade" id="studentResults" role="tabpanel" aria-labelledby="studentResults-tab">
                     <h3 class="mb-3">My Results</h3>
                    <table id="resultTable" class="table table-striped table-bordered animated fadeIn" style="width:100%">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Name</th> <th>Marks</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <div class="alert alert-info d-none" id="resultInfo">Loading results...</div>
                     <div class="alert alert-danger d-none" id="resultError"></div>
                </div>

                 <div class="tab-pane fade" id="courseManagement" role="tabpanel" aria-labelledby="courseManagement-tab">
                      <h3 class="mb-3">Available Courses</h3>
                     <table id="courseManagementTable" class="table table-striped table-bordered animated fadeIn" style="width:100%">
                         <thead>
                             <tr>
                                 <th>Course Code</th>
                                 <th>Course Name</th>
                                 <th>Course Instructor</th>
                                 </tr>
                         </thead>
                         <tbody>
                             </tbody>
                     </table>
                       <div class="alert alert-info d-none" id="courseInfo">Loading courses...</div>
                       <div class="alert alert-danger d-none" id="courseError"></div>
                 </div>

                 <div class="tab-pane fade" id="resultEntry" role="tabpanel" aria-labelledby="resultEntry-tab">
                    <h3 class="mb-3">Enter Student Result</h3>
                    <form id="addResultForm">
                        <div class="row">
                             <div class="col-md-4 form-group">
                                 <label for="resultRollNumber">Student Roll Number</label>
                                 <input type="text" class="form-control" id="resultRollNumber" required>
                                 </div>
                             <div class="col-md-4 form-group">
                                 <label for="resultCourseCode">Course Code</label>
                                 <input type="text" class="form-control" id="resultCourseCode" required>
                                 </div>
                        </div>
                         <div class="row">
                             <div class="col-md-4 form-group">
                                 <label for="resultMarks">Marks</label>
                                 <input type="number" class="form-control" id="resultMarks" required min="0" max="100">
                             </div>
                             <div class="col-md-4 form-group">
                                 <label for="resultGrade">Grade</label>
                                 <input type="text" class="form-control" id="resultGrade" required>
                                 </div>
                         </div>
                         <div class="alert alert-danger d-none" id="addResultError"></div>
                         <div class="alert alert-success d-none" id="addResultSuccess"></div>
                         <button type="submit" class="btn btn-primary">Add Result</button>
                    </form>
                    <hr>
                     <h4 class="mt-4">Existing Results (for My Courses)</h4>
                      <table id="existingResultTable" class="table table-striped table-bordered animated fadeIn mt-3" style="width:100%">
                        <thead>
                            <tr>
                                <th>Roll Number</th>
                                <th>Course Code</th>
                                <th>Marks</th>
                                <th>Grade</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                     <div class="alert alert-info d-none" id="existingResultInfo">Loading existing results...</div>
                     <div class="alert alert-danger d-none" id="existingResultError"></div>
                </div>

                 <div class="tab-pane fade" id="resultDispute" role="tabpanel" aria-labelledby="resultDispute-tab">
                     <div id="studentDisputeSection">
                        <h3 class="mb-3">Submit Result Dispute</h3>
                         <form id="addDisputeForm">
                             <div class="row">
                                <div class="col-md-4 form-group">
                                     <label for="disputeRollNumber">Your Roll Number</label>
                                     <input type="text" class="form-control" id="disputeRollNumber" required readonly> </div>
                                 <div class="col-md-4 form-group">
                                     <label for="disputeCourseCode">Course Code</label>
                                     <input type="text" class="form-control" id="disputeCourseCode" required>
                                     </div>
                             </div>
                             <div class="form-group">
                                 <label for="disputeReason">Reason for Dispute</label>
                                 <textarea class="form-control" id="disputeReason" rows="3" required></textarea>
                             </div>
                             <div class="alert alert-danger d-none" id="addDisputeError"></div>
                             <div class="alert alert-success d-none" id="addDisputeSuccess"></div>
                             <button type="submit" class="btn btn-warning">Submit Dispute</button>
                         </form>
                         <hr>
                         <h4 class="mt-4">My Submitted Disputes</h4>
                         <table id="myDisputeTable" class="table table-striped table-bordered animated fadeIn mt-3" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Submitted On</th> </tr>
                            </thead>
                            <tbody></tbody>
                         </table>
                          <div class="alert alert-info d-none" id="myDisputeInfo">Loading your disputes...</div>
                          <div class="alert alert-danger d-none" id="myDisputeError"></div>
                     </div>

                      <div id="lecturerDisputeSection" class="d-none">
                          <h3 class="mb-3">Manage Result Disputes (for My Courses)</h3>
                         <table id="manageDisputeTable" class="table table-striped table-bordered animated fadeIn mt-3" style="width:100%">
                             <thead>
                                 <tr>
                                     <th>Roll Number</th>
                                     <th>Course Code</th>
                                     <th>Reason</th>
                                     <th>Status</th>
                                     <th>Action</th>
                                 </tr>
                             </thead>
                             <tbody></tbody>
                         </table>
                         <div class="alert alert-info d-none" id="manageDisputeInfo">Loading disputes...</div>
                         <div class="alert alert-danger d-none" id="manageDisputeError"></div>
                     </div>
                </div>

                 <div class="tab-pane fade" id="studentManagement" role="tabpanel" aria-labelledby="studentManagement-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <h3>Add New Student</h3>
                            <form id="addStudentForm">
                                <div class="form-group">
                                    <label for="rollNumber">Roll Number</label>
                                    <input type="text" class="form-control" id="rollNumber" required>
                                </div>
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="alert alert-danger d-none" id="addStudentError"></div>
                                <div class="alert alert-success d-none" id="addStudentSuccess"></div>
                                <button type="submit" class="btn btn-primary">Add Student</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h3>Student List</h3>
                            <table id="studentInfoTable" class="table table-striped table-bordered animated fadeIn" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Roll Number</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                             <div class="alert alert-info d-none" id="studentListInfo">Loading students...</div>
                             <div class="alert alert-danger d-none" id="studentListError"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="courseAddManagement" role="tabpanel" aria-labelledby="courseAddManagement-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <h3>Add New Course</h3>
                            <form id="addCourseForm">
                                <div class="form-group">
                                    <label for="courseCode">Course Code</label>
                                    <input type="text" class="form-control" id="courseCode" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseName">Course Name</label>
                                    <input type="text" class="form-control" id="courseName" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseInstructor">Course Instructor</label>
                                     <input type="text" class="form-control" id="courseInstructor" required>
                                     </div>
                                 <div class="alert alert-danger d-none" id="addCourseError"></div>
                                 <div class="alert alert-success d-none" id="addCourseSuccess"></div>
                                <button type="submit" class="btn btn-primary">Add Course</button>
                            </form>
                        </div>
                         </div>
                </div>

            </div> </div> </div> <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
       <div class="modal-dialog" role="document">
         <div class="modal-content">
           <div class="modal-header">
             <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>
             </button>
           </div>
           <div class="modal-body">
             Are you sure you want to delete this item: <strong id="itemToDelete"></strong>?
             <input type="hidden" id="deleteItemId">
             <input type="hidden" id="deleteItemType">
           </div>
           <div class="modal-footer">
             <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
             <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
           </div>
         </div>
       </div>
     </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script> <script>
        // Global state (replace with better state management if app grows)
        let currentUser = null; // { email: '...', role: '...', token: '...' }
        let dataTables = {}; // Store DataTable instances

        // Helper to show alerts
        function showAlert(id, message, type = 'danger') {
            const alertBox = $(`#${id}`);
            alertBox.removeClass('d-none alert-danger alert-success alert-warning alert-info').addClass(`alert-${type}`).text(message);
        }
        function hideAlert(id) {
            $(`#${id}`).addClass('d-none').text('');
        }

        // Helper to setup DataTable
        function initializeDataTable(tableId, ajaxConfig, columns) {
            if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                dataTables[tableId].destroy();
            }
            dataTables[tableId] = $(`#${tableId}`).DataTable({
                processing: true,
                // serverSide: true, // Consider if data gets large
                ajax: ajaxConfig, // Can be URL string or config object
                columns: columns,
                pageLength: 5,
                lengthChange: false,
                searching: true, // Enable basic search
                info: true,
                 // Handle Ajax errors
                 initComplete: function(settings, json) {
                     hideAlert(`${tableId.replace('Table','')}Info`); // Hide loading message
                 },
                 drawCallback: function(settings) {
                     const api = this.api();
                     if (api.page.info().recordsDisplay === 0) {
                         // Show message if table is empty after filtering/loading
                         $(`#${tableId} tbody`).html('<tr><td colspan="' + columns.length + '" class="text-center">No data available</td></tr>');
                     }
                 }
                // Consider adding error handling for ajax calls within DataTable
            });
             // Add listener for Ajax errors (more robust)
             $(`#${tableId}`).on('error.dt', function(e, settings, techNote, message) {
                 console.error('DataTables Error:', message);
                 showAlert(`${tableId.replace('Table','')}Error`, 'Failed to load data. Please try again.');
                 hideAlert(`${tableId.replace('Table','')}Info`);
             });

             return dataTables[tableId];
        }

         // === API Call Helper ===
         async function apiCall(endpoint, method = 'GET', data = null) {
             const url = `/api${endpoint}`; // Assuming backend runs on same origin
             const options = {
                 method: method,
                 headers: {
                     'Content-Type': 'application/json',
                     // Add Authorization header if using tokens
                     // 'Authorization': `Bearer ${currentUser?.token}`
                 },
             };
             if (data && (method === 'POST' || method === 'PUT')) {
                 options.body = JSON.stringify(data);
             }

             try {
                 const response = await fetch(url, options);
                 if (!response.ok) {
                     let errorData;
                     try {
                         errorData = await response.json();
                     } catch (e) {
                         errorData = { error: `HTTP error! Status: ${response.status}` };
                     }
                     console.error(`API Error (${response.status}) on ${method} ${endpoint}:`, errorData);
                     // Throw an object containing the status and error message
                     throw { status: response.status, message: errorData?.error || `Request failed with status ${response.status}` };
                 }

                 // Handle 204 No Content for DELETE
                 if (response.status === 204) {
                    return null; // Or return a success indicator
                 }

                 return await response.json(); // Parse JSON response body

             } catch (error) {
                 console.error(`Network or Fetch Error on ${method} ${endpoint}:`, error);
                  // Re-throw the structured error or a generic one
                 if (error.status) { // If it's the structured error we threw
                     throw error;
                 } else { // Network error, etc.
                     throw { status: 500, message: 'Network error or unable to connect to the server.' };
                 }
             }
         }


        // === Authentication Logic ===
        function handleLogin(event) {
            event.preventDefault();
            hideAlert('loginError');
            const email = $('#loginEmail').val();
            const password = $('#loginPassword').val();

            apiCall('/auth/login', 'POST', { email, password })
                .then(data => {
                    console.log('Login successful:', data);
                    // Store user info (use localStorage/sessionStorage carefully)
                     currentUser = {
                         email: data.email || email, // Use email from response if available
                         role: data.role || 'student', // Determine role (response should provide this)
                         token: data.idToken // Store token if using JWT
                     };
                     // Persist login state (e.g., in localStorage)
                     localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    showMainContent();
                })
                .catch(error => {
                     console.error('Login failed:', error);
                     showAlert('loginError', error.message || 'Login failed. Please check your credentials.');
                });
        }

        function handleSignup(event) {
            event.preventDefault();
            hideAlert('signupError');
            hideAlert('signupSuccess');
            const email = $('#signupEmail').val();
            const password = $('#signupPassword').val();
            const confirmPassword = $('#signupConfirmPassword').val();

            if (password !== confirmPassword) {
                showAlert('signupError', 'Passwords do not match.');
                return;
            }
             if (password.length < 6) { // Example basic validation
                 showAlert('signupError', 'Password must be at least 6 characters long.');
                 return;
             }

            apiCall('/auth/signup', 'POST', { email, password })
                .then(data => {
                     console.log('Signup successful:', data);
                     showAlert('signupSuccess', data.message || 'Signup successful! You can now log in.');
                     $('#signupForm')[0].reset(); // Clear form
                     // Optionally switch to login tab: $('a[href="#loginTab"]').tab('show');
                })
                .catch(error => {
                     console.error('Signup failed:', error);
                     showAlert('signupError', error.message || 'Signup failed. Please try again.');
                });
        }

         function handleLogout() {
             currentUser = null;
             localStorage.removeItem('currentUser'); // Clear persisted state
             showAuthSection();
             // Optionally redirect to login page window.location.reload();
         }

         // === UI Control ===
         function showAuthSection() {
             $('#authSection').show();
             $('#mainContent').hide();
              // Clear any lingering main content data/tables
             $('#mainTabs').empty();
             $('#mainTabContent').find('.tab-pane').removeClass('show active');
              Object.values(dataTables).forEach(table => {
                 if (table) {
                     table.clear().destroy(); // Clear and destroy tables
                     const tableId = table.table().node().id;
                     $(`#${tableId} tbody`).empty(); // Ensure tbody is empty
                 }
             });
             dataTables = {}; // Reset table tracker
         }

        function showMainContent() {
            $('#authSection').hide();
            $('#mainContent').show();
            $('#welcomeMessage').text(`Welcome, ${currentUser.email}! (Role: ${currentUser.role})`);
            setupTabsForRole(currentUser.role);
             // Activate the first visible tab
             $('#mainTabs li:first-child a').tab('show');
        }

        function setupTabsForRole(role) {
            const tabsContainer = $('#mainTabs');
            const contentContainer = $('#mainTabContent');
            tabsContainer.empty(); // Clear existing tabs

            // Define tabs available for each role
            const allTabs = [
                { id: 'studentResults', label: 'My Results', roles: ['student'] },
                { id: 'resultDispute', label: 'Result Disputes', roles: ['student', 'lecturer'] }, // Combined student/lecturer view logic inside
                { id: 'courseManagement', label: 'View Courses', roles: ['student', 'lecturer'] }, // View only for student?
                { id: 'resultEntry', label: 'Enter Results', roles: ['lecturer'] },
                { id: 'studentManagement', label: 'Manage Students', roles: ['lecturer', 'admin'] }, // Assuming admin role exists
                 { id: 'courseAddManagement', label: 'Manage Courses', roles: ['lecturer', 'admin'] } // Add/Edit Courses
                // Add more tabs: reportGeneration, dataImportExport, etc. with appropriate roles
            ];

            let isFirstTab = true;
            allTabs.forEach(tab => {
                if (tab.roles.includes(role)) {
                    const activeClass = isFirstTab ? 'active' : '';
                    // Nav Link
                    tabsContainer.append(`
                        <li class="nav-item">
                            <a class="nav-link ${activeClass}" id="${tab.id}-tab" data-toggle="tab" href="#${tab.id}" role="tab" aria-controls="${tab.id}" aria-selected="${isFirstTab}">${tab.label}</a>
                        </li>
                    `);
                    // Ensure corresponding Tab Pane exists and set its initial state
                    const tabPane = $(`#${tab.id}`);
                     if (tabPane.length) { // Check if the pane div exists in HTML
                         tabPane.removeClass('show active').addClass('fade');
                         if (isFirstTab) {
                             tabPane.addClass('show active');
                         }
                     } else {
                         console.warn(`Tab pane content div with id #${tab.id} not found in HTML.`);
                     }

                     isFirstTab = false; // Only the first matched tab should be active initially
                } else {
                     // Ensure tabs not relevant to the role are hidden/inactive if they exist
                     $(`#${tab.id}-tab`).parent().remove(); // Remove tab link li
                     $(`#${tab.id}`).removeClass('show active'); // Deactivate tab pane
                 }
            });

             // Special handling for combined tabs like Disputes
            if (role === 'student') {
                $('#studentDisputeSection').removeClass('d-none');
                $('#lecturerDisputeSection').addClass('d-none');
                 $('#disputeRollNumber').val(currentUser.email); // Pre-fill student email/roll
            } else if (role === 'lecturer') {
                $('#studentDisputeSection').addClass('d-none'); // Hide student's add form
                $('#lecturerDisputeSection').removeClass('d-none');
            }

             // Trigger loading data for the initially active tab
             const firstTabId = $('#mainTabs li:first-child a').attr('href');
             if (firstTabId) {
                 loadDataForTab(firstTabId.substring(1)); // Remove #
             }
        }


         // === Data Loading for Tabs ===
         function loadDataForTab(tabId) {
             console.log(`Loading data for tab: ${tabId}`);
             hideAlert(`${tabId}Error`); // Hide previous errors
             showAlert(`${tabId}Info`, 'Loading data...'); // Show loading indicator

             switch (tabId) {
                 case 'studentResults':
                     loadStudentResults();
                     break;
                 case 'courseManagement':
                 case 'courseAddManagement': // Both might need the course list
                     loadCourses();
                     break;
                 case 'resultEntry':
                     loadExistingResults(); // Lecturer's existing results
                     break;
                  case 'resultDispute':
                      if (currentUser.role === 'student') {
                          loadMyDisputes();
                          $('#disputeRollNumber').val(currentUser.email); // Ensure pre-fill
                      } else if (currentUser.role === 'lecturer') {
                          loadManageDisputes();
                      }
                     break;
                 case 'studentManagement':
                     loadStudents();
                     break;
                 // Add cases for other tabs
             }
         }

         function loadStudentResults() {
              // TODO: This needs modification. Get results FOR THE CURRENT STUDENT.
              // The backend API /api/results currently gets ALL results.
              // Needs a new backend endpoint like /api/students/me/results or /api/results?rollNumber=...
              // For now, we'll fetch all and filter client-side (INEFFICIENT!)
              showAlert('resultInfo', 'Loading your results...');
              apiCall('/results') // <<-- NEEDS BACKEND CHANGE
                  .then(results => {
                     const myResults = results.filter(r => r.rollNumber === currentUser.email); // <<-- Inefficient filtering

                     initializeDataTable('resultTable', { data: myResults }, [ // Use data option for client-side data
                         { data: 'courseCode' },
                         { data: 'courseName', defaultContent: '<i>N/A</i>' }, // Need course name - requires joining data or separate fetch
                         { data: 'marks' },
                         { data: 'grade' }
                     ]);
                      hideAlert('resultInfo');
                  })
                  .catch(error => {
                      showAlert('resultError', `Failed to load results: ${error.message}`);
                       hideAlert('resultInfo');
                  });
         }

         function loadCourses() {
             const tableId = 'courseManagementTable'; // Table used in multiple tabs
             showAlert('courseInfo', 'Loading courses...');
              initializeDataTable(tableId, {
                  url: '/api/courses', // Direct URL for ajax source
                  dataSrc: '' // Response is the array itself
                 }, [
                  { data: 'courseCode' },
                  { data: 'courseName' },
                  { data: 'courseInstructor' },
                  // Add actions column conditionally for lecturer/admin
                  // {
                  //     data: 'id', // Use course ID for actions
                  //     render: function(data, type, row) {
                  //         if (currentUser.role === 'lecturer' || currentUser.role === 'admin') {
                  //             return `<button class="btn btn-sm btn-danger delete-btn" data-id="${data}" data-type="course">Delete</button>`;
                  //             // Add Edit button later
                  //         }
                  //         return ''; // No actions for students
                  //     },
                  //      orderable: false
                  // }
              ]);
               hideAlert('courseInfo'); // Datatables handles its own loading/error usually
         }

        function loadExistingResults() {
            // TODO: Backend needs endpoint for lecturer's results, e.g., /api/results?instructor=...
            // Fetching all is inefficient. Simulating for now.
            showAlert('existingResultInfo', 'Loading existing results...');
            apiCall('/results') // <<-- NEEDS BACKEND CHANGE
                .then(results => {
                     // TODO: Filter results based on courses taught by the current lecturer
                     // This requires knowing which courses the lecturer teaches. Needs another API call or different backend structure.
                     // const lecturerCourses = await apiCall('/lecturers/me/courses'); // Fictional endpoint
                     // const filteredResults = results.filter(r => lecturerCourses.includes(r.courseCode));

                     // For demo, showing all results (incorrect for actual role)
                    initializeDataTable('existingResultTable', { data: results }, [
                        { data: 'rollNumber' },
                        { data: 'courseCode' },
                        { data: 'marks' },
                        { data: 'grade' },
                        {
                             data: 'id',
                             render: function(data, type, row) {
                                 // Assume lecturer can delete results they added (or any result?)
                                 return `<button class="btn btn-sm btn-danger delete-btn" data-id="${data}" data-type="result">Delete</button>`;
                             },
                              orderable: false
                        }
                    ]);
                     hideAlert('existingResultInfo');
                })
                .catch(error => {
                    showAlert('existingResultError', `Failed to load existing results: ${error.message}`);
                    hideAlert('existingResultInfo');
                });
        }

        function loadMyDisputes() {
             // TODO: Backend needs endpoint like /api/disputes?rollNumber=currentUser.email
             showAlert('myDisputeInfo', 'Loading your disputes...');
              apiCall('/disputes') // <<-- NEEDS BACKEND CHANGE
                .then(disputes => {
                    const myDisputes = disputes.filter(d => d.rollNumber === currentUser.email); // <<-- Inefficient
                     initializeDataTable('myDisputeTable', { data: myDisputes }, [
                         { data: 'courseCode' },
                         { data: 'reason' },
                         { data: 'status' },
                          { data: 'submissionTime', defaultContent: '<i>N/A</i>' } // Need timestamp from backend
                     ]);
                      hideAlert('myDisputeInfo');
                })
                .catch(error => {
                      showAlert('myDisputeError', `Failed to load disputes: ${error.message}`);
                      hideAlert('myDisputeInfo');
                  });
        }

        function loadManageDisputes() {
            // TODO: Backend needs endpoint like /api/disputes?instructor=...
            showAlert('manageDisputeInfo', 'Loading disputes for your courses...');
             apiCall('/disputes') // <<-- NEEDS BACKEND CHANGE
                 .then(disputes => {
                     // TODO: Filter disputes related to lecturer's courses
                     initializeDataTable('manageDisputeTable', { data: disputes }, [ // Showing all for demo
                         { data: 'rollNumber' },
                         { data: 'courseCode' },
                         { data: 'reason' },
                         { data: 'status' },
                         {
                             data: 'id',
                             render: function(data, type, row) {
                                  // Add buttons to change status (Resolve, Reject)
                                 return `<button class="btn btn-sm btn-success resolve-dispute-btn" data-id="${data}">Resolve</button>
                                         <button class="btn btn-sm btn-warning reject-dispute-btn" data-id="${data}">Reject</button>`;
                             },
                              orderable: false
                         }
                     ]);
                      hideAlert('manageDisputeInfo');
                 })
                 .catch(error => {
                     showAlert('manageDisputeError', `Failed to load disputes: ${error.message}`);
                     hideAlert('manageDisputeInfo');
                 });
        }

         function loadStudents() {
             const tableId = 'studentInfoTable';
             showAlert('studentListInfo', 'Loading students...');
             initializeDataTable(tableId, {
                 url: '/api/students',
                 dataSrc: ''
                }, [
                 { data: 'rollNumber' },
                 { data: 'name' },
                 { data: 'email' },
                 {
                     data: 'id',
                     render: function(data, type, row) {
                         // Add actions like Edit, Delete
                          return `<button class="btn btn-sm btn-danger delete-btn" data-id="${data}" data-type="student">Delete</button>`;
                          // Add Edit button later
                     },
                      orderable: false
                 }
             ]);
               hideAlert('studentListInfo');
         }


         // === Form Submission Handlers ===
         function handleAddStudent(event) {
             event.preventDefault();
             hideAlert('addStudentError');
             hideAlert('addStudentSuccess');
             const student = {
                 rollNumber: $('#rollNumber').val(),
                 name: $('#name').val(),
                 email: $('#email').val()
             };

             apiCall('/students', 'POST', student)
                 .then(newStudent => {
                     showAlert('addStudentSuccess', `Student ${newStudent.name} added successfully!`, 'success');
                     $('#addStudentForm')[0].reset();
                     // Refresh student list table
                     if (dataTables['studentInfoTable']) {
                         dataTables['studentInfoTable'].ajax.reload();
                     }
                 })
                 .catch(error => {
                     showAlert('addStudentError', `Failed to add student: ${error.message}`);
                 });
         }

          function handleAddCourse(event) {
             event.preventDefault();
             hideAlert('addCourseError');
             hideAlert('addCourseSuccess');
             const course = {
                 courseCode: $('#courseCode').val(),
                 courseName: $('#courseName').val(),
                 courseInstructor: $('#courseInstructor').val() // Might auto-fill if lecturer
             };

             apiCall('/courses', 'POST', course)
                 .then(newCourse => {
                     showAlert('addCourseSuccess', `Course ${newCourse.courseCode} added successfully!`, 'success');
                     $('#addCourseForm')[0].reset();
                     // Refresh course list table
                     if (dataTables['courseManagementTable']) {
                         dataTables['courseManagementTable'].ajax.reload();
                     }
                 })
                 .catch(error => {
                     showAlert('addCourseError', `Failed to add course: ${error.message}`);
                 });
         }

          function handleAddResult(event) {
             event.preventDefault();
             hideAlert('addResultError');
             hideAlert('addResultSuccess');
              const result = {
                 rollNumber: $('#resultRollNumber').val(),
                 courseCode: $('#resultCourseCode').val(),
                  // Ensure marks is an integer
                 marks: parseInt($('#resultMarks').val(), 10),
                 grade: $('#resultGrade').val()
             };

              if (isNaN(result.marks)) {
                 showAlert('addResultError', 'Marks must be a valid number.');
                 return;
             }

             apiCall('/results', 'POST', result)
                 .then(newResult => {
                     showAlert('addResultSuccess', `Result added successfully for ${newResult.rollNumber}!`, 'success');
                     $('#addResultForm')[0].reset();
                      // Refresh existing results table
                     if (dataTables['existingResultTable']) {
                         dataTables['existingResultTable'].ajax.reload();
                     }
                 })
                 .catch(error => {
                     showAlert('addResultError', `Failed to add result: ${error.message}`);
                 });
         }

          function handleAddDispute(event) {
             event.preventDefault();
             hideAlert('addDisputeError');
             hideAlert('addDisputeSuccess');
              const dispute = {
                  rollNumber: $('#disputeRollNumber').val(), // Should be pre-filled and readonly
                  courseCode: $('#disputeCourseCode').val(),
                  reason: $('#disputeReason').val(),
                  status: 'pending' // Default status
              };

              apiCall('/disputes', 'POST', dispute)
                 .then(newDispute => {
                     showAlert('addDisputeSuccess', 'Dispute submitted successfully!', 'success');
                     $('#addDisputeForm')[0].reset();
                     // Re-fill roll number after reset
                      $('#disputeRollNumber').val(currentUser.email);
                      // Refresh my disputes table
                     if (dataTables['myDisputeTable']) {
                         dataTables['myDisputeTable'].ajax.reload();
                     }
                 })
                 .catch(error => {
                     showAlert('addDisputeError', `Failed to submit dispute: ${error.message}`);
                 });
          }

         // === Action Handlers (e.g., Delete) ===
         function handleDeleteClick(event) {
              const button = $(event.target);
              const itemId = button.data('id');
              const itemType = button.data('type'); // 'course', 'student', 'result', etc.
              const itemName = button.closest('tr').find('td').eq(0).text(); // Get first cell text as name

              // Populate and show confirmation modal
              $('#itemToDelete').text(`${itemType} (${itemName || itemId})`);
              $('#deleteItemId').val(itemId);
              $('#deleteItemType').val(itemType);
              $('#deleteConfirmModal').modal('show');
         }

          function confirmDelete() {
              const itemId = $('#deleteItemId').val();
              const itemType = $('#deleteItemType').val();
              let endpoint = '';
              let tableToRefresh = '';

               switch(itemType) {
                   case 'course':
                       endpoint = `/courses/${itemId}`;
                       tableToRefresh = 'courseManagementTable';
                       break;
                    case 'student':
                       endpoint = `/students/${itemId}`;
                        tableToRefresh = 'studentInfoTable';
                       break;
                     case 'result':
                         endpoint = `/results/${itemId}`;
                         tableToRefresh = 'existingResultTable'; // Or studentResultTable?
                         break;
                    // Add cases for lecturer, dispute etc.
                   default:
                       console.error('Unknown item type for deletion:', itemType);
                       $('#deleteConfirmModal').modal('hide');
                       return;
               }

              apiCall(endpoint, 'DELETE')
                  .then(() => {
                      console.log(`${itemType} with ID ${itemId} deleted successfully.`);
                       $('#deleteConfirmModal').modal('hide');
                       // Refresh the corresponding table
                       if (dataTables[tableToRefresh]) {
                           dataTables[tableToRefresh].ajax.reload();
                       } else {
                            console.warn(`Table ${tableToRefresh} not found or initialized.`);
                            // May need to manually reload data for the active tab
                            const activeTabId = $('#mainTabs .active').attr('href')?.substring(1);
                            if (activeTabId) loadDataForTab(activeTabId);
                       }
                      // Optionally show a success notification
                  })
                  .catch(error => {
                       console.error(`Failed to delete ${itemType} ${itemId}:`, error);
                       $('#deleteConfirmModal').modal('hide');
                       // Show an error message to the user (e.g., using a toast notification library)
                       alert(`Error deleting ${itemType}: ${error.message}`);
                  });
          }


        // === Initialization ===
        $(document).ready(function() {

            // --- Event Listeners ---
            $('#loginForm').submit(handleLogin);
            $('#signupForm').submit(handleSignup);
            $('#logoutButton').click(handleLogout);

            // Form submission listeners
             $('#addStudentForm').submit(handleAddStudent);
             $('#addCourseForm').submit(handleAddCourse);
             $('#addResultForm').submit(handleAddResult);
             $('#addDisputeForm').submit(handleAddDispute);

              // Listener for delete buttons in tables (using event delegation)
             $('#mainTabContent').on('click', '.delete-btn', handleDeleteClick);
             $('#confirmDeleteButton').click(confirmDelete);

            // Listener for tab changes to load data
            $('#mainTabs').on('shown.bs.tab', function (event) {
                 const newTabId = $(event.target).attr('href').substring(1); // Get id of the activated tab pane
                loadDataForTab(newTabId);
            });


            // --- Initial Check for Logged-in User ---
             const storedUser = localStorage.getItem('currentUser');
             if (storedUser) {
                 try {
                     currentUser = JSON.parse(storedUser);
                     // TODO: Optionally verify token validity with backend here
                     if (currentUser && currentUser.email && currentUser.role) {
                         showMainContent();
                     } else {
                          // Invalid stored data
                          handleLogout(); // Clear invalid state
                     }
                 } catch (e) {
                      console.error("Error parsing stored user data", e);
                      handleLogout(); // Clear invalid state
                 }
             } else {
                 showAuthSection();
             }

            // --- Dummy Data & Old DataTable Init (Remove/Comment Out) ---
            // const studentData = [ ... ]; // REMOVE DUMMY DATA
            // const table = $("#resultTable").DataTable({ ... }); // REMOVE OLD INIT
            // $("#searchBtn").click(function() { ... }); // REMOVE OLD SEARCH

            console.log("SRM Frontend Initialized.");
        });
    </script>
</body>
</html>
